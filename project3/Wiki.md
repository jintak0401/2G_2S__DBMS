<pre>

[ insert / delete ] 함수 모식도
 
|---------------------------------------------------------------------------------------------------------------------------------------------------   insert / delete  ----------------------------------------------------------------------------------------------------------------------------------------------------|
|                                                                                                                                                                                                                                                                                                                           |
|                                                                                                                                                                                                                                                                                                                           |
|                                                                                                                                                                                                                                                                                                                           |
|                                    |-------------------------------------------------------------------------------------------   insert_into_leaf(_after_splitting) / delete_entry  --------------------------------------------------------------------------------------------------|                                  |
|                                    |                                                                                                                                                                                                                                                   |                                  |
|                                    |                                                                                                                                                                                                                                                   |                                  |
|                                    |                                                                                                                                                                                                                                                   |                                  |
|       _____________________        |                                                                                                                                                                                                                                                   |       _____________________      |
|       |                   |        |                                                             insertion / deletion 이후 key 개수에 따라 insert_into_leaf, insert_into_leaf_after_splitting / coalesce_page 호출                                                                     |       |                   |      |
|       |                   | ================================================================================================================================================================================================================================================================▶ |                   |      |
|       |                   |        |         ||                                                                                                                                                                                                                                /\      |       |                   |      |
|       |    해당 key 가    |        |         ||                                                                                                                                                                                                                               /||\     |       |  기존 leaf page   |      |
|       |       처리될      |        |         ||                                                                                                                                                                                                                                ||      |       |        저장       |      |
|       |     leaf page     |        |         ||                                          |-------------------------------------------------   insert_into_parent / coalesce_page ------------------------------------------------------|                                       ||      |       |                   |      |
|       |                   |        |         ||             ______________________       |                                                                                                                                             |        ______________________         ||      |       |                   |      |
|       |                   |        |         ||            |                      |      |                                            record 들을 나누거나(split) / 합침(merge)                                                        |       |                      |        ||      |       |                   |      |
|       |___________________|        |         ||            |                      | ========================================================================================================================================================▶ |                      |        ||      |       |___________________|      |
|                                    |         ||            |                      |      |                                                                                                                                             |       |                      |        ||      |                                  |
|                                    |         ||            |   기존 leaf 영향을   |      |                                                                                                                                             |       |   추가적 leaf page   |        ||      |                                  |
|                                    |         ||_______\    |      미칠 추가적     |      |                                 |----------  insert_into_internal 등의 함수 / delete_entry 함수  ----------|                                |       |         저장         | _______||      |                                  |
|                                    |          ㅡㅡㅡㅡ/    |       leaf page      |      |                                 |                                                                          |                                |       |                      | ㅡㅡㅡㅡ       |                                  |
|                                    |        insertion 시   |                      |      |        ______________________   |                                                                          |    ______________________      |       |                      |  deletetion 시 |                                  |
|                                    |      초과하면 split   |                      |      |       |                      |  |              split / merge 결과를 internal page 에 반영                  |   |                      |     |       |                      |  key 개수 = 0  |                                  |
|                                    |                       |                      |      |       |                      |==============================================================================▶ |                      |     |       |                      |   되면 merge   |                                  |
|                                    |                       |______________________|      |       |                      |  |                                                                          |   |                      |     |       |______________________|                |                                  |
|                                    |                                                     |       |    추가적 leaf 를    |  |                                                                          |   |   internal page      |     |                                               |                                  |
|                                    |                                                     |       |        반영할        |  |                                                                          |   |        저장          |     |                                               |                                  |
|                                    |                                                     |       |    internal page     |  |                                                                          |   |                      |     |                                               |                                  |
|                                    |                                                     |       |                      |  |                                                                          |   |                      |     |                                               |                                  |
|                                    |                                                     |       |                      |  |                                                                          |   |                      |     |                                               |                                  |
|                                    |                                                     |       |                      |  |                                                                          |   |                      |     |                                               |                                  |
|                                    |                                                     |       |______________________|  |                                                                          |   |______________________|     |                                               |                                  |
|        _____________________       |                                                     |                                 |                                                                          |                                |                                               |       _____________________      |
|        |                   |       |                                                     |                                 |                                                                          |                                |                                               |       |                   |      |
|        |                   |       |                                                     |                                 |                                                                          |                                |                                               |       |                   |      |
|        |                   |       |                                                     |                                 |__________________________________________________________________________|                                |                                               |       |                   |      |
|        |     root page     |       |                                                     |                                                                                                                                             |                                               |       |     root page     |      |
|        |         &         |       |                                                     |                                                                                                                                             |                                               |       |   & header page   |      |
|        |    header page    | ===============================================================================================================================================================================================================================================================▶ |        저장       |      |
|        |                   |       |                                                     |                                                                                                                                             |                                               |       |                   |      |
|        |                   |       |                                                     |_____________________________________________________________________________________________________________________________________________|                                               |       |                   |      |
|        |___________________|       |                                                                                                                                                                                                                                                   |       |___________________|      |
|                                    |___________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________|                                  |
|                                                                                                                                                                                                                                                                                                                           |
|                                                                                                                                                                                                                                                                                                                           |
|___________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________|
                                                                                                                                                                                                                                                                                                                                        

</pre>


<br/>
<br/>


저번 과제의 disk based b plus tree 와 비슷한 구조로 돌아갑니다. 그래서 저번 코드와의 차이점에 대해서만 설명하겠습니다

<br/>
<br/>


1. Buffer


<br/>
buffer 를 담는 배열과, 현재 buffer 가 얼마나 들어있는지(= size), 얼마나 들어갈 수 있는지(= capacity), LRU 정책을 위한 현재 시계바늘 위치(= current)를 담는 buffer_pool 을 생성하여 버퍼를 관리합니다.
buffer_pool 에 담기는 buffer 구조체는 frame, table_id, page_num, is_dirty, is_pinned, referenced 로 구성되어 있습니다. referenced 는 LRU 정책을 위한 시계가 한바퀴 돌기 전, 참조되었다는 의미의 int 타입 변수입니다.
index layer 에게 call 되어 해당 테이블의 페이지를 찾는 것은 선형으로 탐색합니다.(추후에 좀 더 빠르게 탐색할 수 있도록 수정하려고 합니다.
저의 bpt 코드상 header 와 root 에 자주 접근이 되어 최대한 버퍼 내에서 삭제를 시키지 않도록 하려고 했으나, 어차피 많이 불리기 때문에 referenced 가 항상 켜져있어서 굳이 그런 작업 없이도 충분히 오래 남아있을 것이기 때문에 굳이 특별한 조취를 취하지 않았습니다.


<br/>
<br/>


2. table_id


<br/>
file direction 배열인 fd 를 사용하여 table 을 관리합니다. 1 부터 10 까지의 table_id 를 만들어야 하므로 int fd[11] 을 file_manager.c 내의 전역변수로 사용하여 fd[table_id] 로 접근하도록 하였습니다.



<br/>
<br/>

3. pinning 과 unpinning


<br/>
insert 및 delete 시 page 를 읽어들일 때 pinning 을 하며 다시 저장할 때 unpinning 을 합니다. 따라서 모식도상 바깥쪽에 존재하는 page 일 수록 pinning 이 오래 되며 안쪽에 있을 수록 pinning 된 시간이 짧습니다.
그런데 제 bpt 상에서 root 와 header 는 항상 호출되는데, 혼자 db 를 사용하는 지금은 괜찮지만 나중에 문제가 있을 수 있을 것 같습니다.
그래서 다음 과제 제출 시에, header 는 find, insert, delete 이 호출된 직후와 페이지의 수가 늘어나거나 root 가 바뀌는 등의 상황에서만 버퍼에 요청하고, root 또한 root 의 변경이 필요할 경우에만 호출되도록 변경할 예정입니다.
