<pre>

[ insert / delete ] 함수 모식도
 
|---------------------------------------------------------------------------------------------------------------------------------------------------   insert / delete  ----------------------------------------------------------------------------------------------------------------------------------------------------|
|                                                                                                                                                                                                                                                                                                                           |
|                                                                                                                                                                                                                                                                                                                           |
|                                                                                                                                                                                                                                                                                                                           |
|                                    |-------------------------------------------------------------------------------------------   insert_into_leaf(_after_splitting) / delete_entry  --------------------------------------------------------------------------------------------------|                                  |
|                                    |                                                                                                                                                                                                                                                   |                                  |
|                                    |                                                                                                                                                                                                                                                   |                                  |
|                                    |                                                                                                                                                                                                                                                   |                                  |
|       _____________________        |                                                                                                                                                                                                                                                   |       _____________________      |
|       |                   |        |                                                             insertion / deletion 이후 key 개수에 따라 insert_into_leaf, insert_into_leaf_after_splitting / coalesce_page 호출                                                                     |       |                   |      |
|       |                   | ================================================================================================================================================================================================================================================================▶ |                   |      |
|       |                   |        |         ||                                                                                                                                                                                                                                /\      |       |                   |      |
|       |    해당 key 가    |        |         ||                                                                                                                                                                                                                               /||\     |       |  기존 leaf page   |      |
|       |       처리될      |        |         ||                                                                                                                                                                                                                                ||      |       |        저장       |      |
|       |     leaf page     |        |         ||                                          |-------------------------------------------------   insert_into_parent / coalesce_page ------------------------------------------------------|                                       ||      |       |                   |      |
|       |                   |        |         ||             ______________________       |                                                                                                                                             |        ______________________         ||      |       |                   |      |
|       |                   |        |         ||            |                      |      |                                            record 들을 나누거나(split) / 합침(merge)                                                        |       |                      |        ||      |       |                   |      |
|       |___________________|        |         ||            |                      | ========================================================================================================================================================▶ |                      |        ||      |       |___________________|      |
|                                    |         ||            |                      |      |                                                                                                                                             |       |                      |        ||      |                                  |
|                                    |         ||            |   기존 leaf 영향을   |      |                                                                                                                                             |       |   추가적 leaf page   |        ||      |                                  |
|                                    |         ||_______\    |      미칠 추가적     |      |                                 |----------  insert_into_internal 등의 함수 / delete_entry 함수  ----------|                                |       |         저장         | _______||      |                                  |
|                                    |          ㅡㅡㅡㅡ/    |       leaf page      |      |                                 |                                                                          |                                |       |                      | ㅡㅡㅡㅡ       |                                  |
|                                    |        insertion 시   |                      |      |        ______________________   |                                                                          |    ______________________      |       |                      |  deletetion 시 |                                  |
|                                    |      초과하면 split   |                      |      |       |                      |  |              split / merge 결과를 internal page 에 반영                  |   |                      |     |       |                      |  key 개수 = 0  |                                  |
|                                    |                       |                      |      |       |                      |==============================================================================▶ |                      |     |       |                      |   되면 merge   |                                  |
|                                    |                       |______________________|      |       |                      |  |                                                                          |   |                      |     |       |______________________|                |                                  |
|                                    |                                                     |       |    추가적 leaf 를    |  |                                                                          |   |   internal page      |     |                                               |                                  |
|                                    |                                                     |       |        반영할        |  |                                                                          |   |        저장          |     |                                               |                                  |
|                                    |                                                     |       |    internal page     |  |                                                                          |   |                      |     |                                               |                                  |
|                                    |                                                     |       |                      |  |                                                                          |   |                      |     |                                               |                                  |
|                                    |                                                     |       |                      |  |                                                                          |   |                      |     |                                               |                                  |
|                                    |                                                     |       |                      |  |                                                                          |   |                      |     |                                               |                                  |
|                                    |                                                     |       |______________________|  |                                                                          |   |______________________|     |                                               |                                  |
|        _____________________       |                                                     |                                 |                                                                          |                                |                                               |       _____________________      |
|        |                   |       |                                                     |                                 |                                                                          |                                |                                               |       |                   |      |
|        |                   |       |                                                     |                                 |                                                                          |                                |                                               |       |                   |      |
|        |                   |       |                                                     |                                 |__________________________________________________________________________|                                |                                               |       |                   |      |
|        |     root page     |       |                                                     |                                                                                                                                             |                                               |       |     root page     |      |
|        |         &         |       |                                                     |                                                                                                                                             |                                               |       |   & header page   |      |
|        |    header page    | ===============================================================================================================================================================================================================================================================▶ |        저장       |      |
|        |                   |       |                                                     |                                                                                                                                             |                                               |       |                   |      |
|        |                   |       |                                                     |_____________________________________________________________________________________________________________________________________________|                                               |       |                   |      |
|        |___________________|       |                                                                                                                                                                                                                                                   |       |___________________|      |
|                                    |___________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________|                                  |
|                                                                                                                                                                                                                                                                                                                           |
|                                                                                                                                                                                                                                                                                                                           |
|___________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________|
                                                                                                                                                                                                                                                                                                                                        

</pre>


<br/>
<br/>


기본적으로 기존의 b plus tree 와 비슷한 구조로 돌아갑니다. 그래서 저번 코드와의 차이점에 대해서만 설명하겠습니다

<br/>
<br/>


1. 파일 저장방식


<br/>
저번 bpt 코드는 메모리에서만 작동하는 코드였으나 이번 코드는 파일로 저장하여야 합니다. insert / delete 함수 실행시 결과를 반영할 leaf 와 root, header 페이지를 db_insert, db_ delete 함수 내에서 읽습니다. 
함수를 진행하며 insert_into_parent, insert_into_leaf_after_splitting / coalesce_page 등 다른 함수가 호출되어 기존 페이지 외의, 다른 페이지 정보가 추가 / 삭제 되어야 한다면 해당 페이지를 추가적으로 파일로부터 읽습니다.
필요한 처리 이후에 추가적으로 페이지를 읽은 함수의 가장 마지막에 결과를 파일에 반영하고 함수를 return 합니다.
최종적으로 db_insert / db_delete 함수로 돌아와 최초로 읽은 leaf 페이지를 파일에 반영하고, root, head 의 정보가 수정되었다면 이 또한 파일에 반영합니다.


<br/>
<br/>


2. delayed merge


<br/>
기존 bpt 코드는 delete 시 internal_node, leaf_node 의 key 개수가 절반으로 떨어진다면 바로 merge 를 하거나, merge 시 허용범위를 초과한다면 redistribute_node 를 했습니다. 
이번 bpt 코드는 file I/O 를 최대한 줄이기 위하여 delete 시 key 개수가 1개 이상일 때까지 해당 페이지를 유지하며, 모든 key 가 제거되었을 때 이웃한 페이지에 merge 됩니다.
따라서 redistribute_node 와 같은 역할을 수행하는 redistribute_page 함수는 없습니다.


<br/>
<br/>

3. free page


<br/>
모든 key 가 제거된 internal_page, leaf_page 들은 free_page 가 됩니다. 링크드 리스트처럼 header 가 시작점이고 free_page 들이 다음 free_page 를 가리키는 형태로 저장됩니다.
그런데 가장 마지막 free_page 에 추가적으로 free_page 를 저장하게 되면 file I/O 가 매우 많이 일어나므로 file_alloc_page, file_free_page 함수를 통해 free_page 를 할당하거나 받을 때 항상 헤더페이지가 가리키고 있는 free_page 를 이용하였습니다.
file_alloc_page 시 header 가 가리키는 free_page 를 반환하고, header 가 가리키는 free_page 를, 반환되는 free_page 가 가리키던 페이지로 수정합니다. file_free_page 시 header 가 인자로 받은 페이지를 가리키고, 해당 페이지는 header 가 기존에 가리키던 페이지를 가리키게 됩니다.
그리고 free_page 를 미리 할당하지 않고, 낭비되는 페이지가 없도록 필요할 때마다 할당받는 방식으로 구현하였습니다. 
